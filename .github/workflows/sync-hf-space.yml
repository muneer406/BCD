name: Sync backend → HF Space
on:
  push:
    branches:
      - main
      - master
    paths:
      - "backend/**"
  workflow_dispatch:

jobs:
  sync:
    name: Push backend/ to Hugging Face Space
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout the full repo ──────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Configure git identity + HF credentials ────────────────────────
      - name: Configure git & credentials
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"

          # Debug: confirm token is present and looks valid
          echo "HF_TOKEN length   : ${#HF_TOKEN}"
          echo "HF_TOKEN prefix   : ${HF_TOKEN:0:5}"   # should print 'hf_xx'

          # Store credentials so git never prompts / embeds token in URLs
          git config --global credential.helper store
          echo "https://muneer320:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          chmod 600 ~/.git-credentials
          echo "Credentials stored."

      # ── 3. Clone the HF Space repo ─────────────────────────────────────────
      - name: Clone HF Space
        env:
          HF_SPACE_ID: ${{ vars.HF_SPACE_ID }}
        run: |
          echo "HF_SPACE_ID: ${HF_SPACE_ID}"
          # Use plain HTTPS URL — credentials come from ~/.git-credentials
          git clone "https://huggingface.co/spaces/${HF_SPACE_ID}" hf-space
          echo "Clone succeeded."

      # ── 4. Sync backend/ → root of the HF Space ───────────────────────────
      - name: Sync files
        run: |
          rsync -av --delete --exclude='.git' backend/ hf-space/
          echo "Rsync complete."

      # ── 5. Commit & push (only if something actually changed) ─────────────
      - name: Push to HF Space
        env:
          HF_SPACE_ID: ${{ vars.HF_SPACE_ID }}
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          cd hf-space
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to sync – skipping push."
          else
            git commit -m "sync: GitHub ${SHORT_SHA}"
            # Credentials from store — no token in the URL
            git push "https://huggingface.co/spaces/${HF_SPACE_ID}" main
            echo "Push succeeded."
          fi
